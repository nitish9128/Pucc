<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>View Reminders</title>
  <style>
    body {
      margin: 0;
      height: 100vh;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      font-family: Arial, sans-serif;
      position: relative;
      overflow: auto;
      padding-top: 20px;
      background: #0d0d0d;
    }

    body::before {
      content: "";
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: linear-gradient(45deg, red, orange, yellow, green, cyan, blue, violet, red);
      animation: bgMove 15s linear infinite;
      z-index: -2;
    }

    @keyframes bgMove {
      0% {
        transform: rotate(0deg);
      }

      50% {
        transform: rotate(180deg);
      }

      100% {
        transform: rotate(360deg);
      }
    }

    .list-box {
      position: relative;
      width: 90%;
      max-width: 1000px;
      margin: auto;
      padding: 20px;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 20px;
      border: 4px solid;
      border-image: linear-gradient(45deg, red, orange, yellow, green, cyan, blue, violet, red) 1;
      box-shadow: 0 0 25px rgba(255, 255, 255, 0.2);
      color: white;
    }

    #searchInput {
      width: 90%;
      padding: 10px;
      margin: 10px 0;
      border-radius: 12px;
      border: none;
      background: rgba(17, 17, 17, 0.7);
      color: white;
      font-size: 16px;
    }

    #totalCount {
      margin-bottom: 10px;
      font-size: 16px;
      color: white;
    }

    .list-box table {
      width: 100%;
      border-collapse: collapse;
      color: white;
    }

    .list-box th,
    .list-box td {
      border: 1px solid white;
      padding: 8px;
      text-align: center;
    }

    .list-box button {
      margin: 5px;
      padding: 5px 10px;
      border: none;
      border-radius: 10px;
      background: rgba(17, 17, 17, 0.7);
      color: white;
      cursor: pointer;
      box-shadow: 0 0 15px red, 0 0 20px blue;
      animation: rainbowGlow 4s linear infinite;
    }

    @keyframes rainbowGlow {
      0% {
        box-shadow: 0 0 15px red, 0 0 20px orange;
      }

      25% {
        box-shadow: 0 0 15px yellow, 0 0 20px green;
      }

      50% {
        box-shadow: 0 0 15px cyan, 0 0 20px blue;
      }

      75% {
        box-shadow: 0 0 15px violet, 0 0 20px red;
      }

      100% {
        box-shadow: 0 0 15px red, 0 0 20px orange;
      }
    }

    #reminderTable1 {
      background-color: #0d0d0d;
    }
  </style>
</head>

<body>
  <div class="list-box">
    <h2>Reminders List</h2>
    <button onclick="window.location.href='dashboard.html'">Back to Dashboard</button>
    <input type="text" id="searchInput" placeholder="Search by Name, Mobile, or Vehicle" onkeyup="filterTable()">
    <p id="totalCount">Total Vehicles: 0</p>



    <table id="reminderTable">
      <thead>
        <tr>
          <th>Name</th>
          <th>Mobile</th>
          <th>Vehicle</th>
          <th>Expiry</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody id="tableBody"></tbody>
    </table>
  </div>

  <script>

    if (sessionStorage.getItem("loggedIn") !== "true") { window.location.href = "login.html"; }

    let reminders = JSON.parse(localStorage.getItem("reminders") || "[]");

    function loadReminders(data = reminders) {
      let table = document.getElementById("reminderTable");
      // table.innerHTML = '<tr><th>Name</th><th>Mobile</th><th>Vehicle</th><th>Expiry</th><th>Action</th></tr>';
let tbody = document.getElementById("tableBody");
tbody.innerHTML="";



      data.forEach((r, i) => {


        let row = tbody.insertRow();
        
          // let row = table.insertRow();
        row.insertCell(0).innerText = r.name;
        row.insertCell(1).innerText = r.mobile;
        row.insertCell(2).innerText = r.vehicle;
        row.insertCell(3).innerText = r.expiry;
        let cell = row.insertCell(4);

        let editBtn = document.createElement("button");
        editBtn.innerText = "Edit";
        editBtn.onclick = () => { localStorage.setItem("editIndex", i); window.location.href = "add.html"; }

        let delBtn = document.createElement("button");
        delBtn.innerText = "Delete";
        delBtn.onclick = () => {
          if (confirm("Delete this reminder?")) {
            reminders.splice(i, 1);
            localStorage.setItem("reminders", JSON.stringify(reminders));
            loadReminders();
          }
        }

        cell.appendChild(editBtn);
        cell.appendChild(delBtn);




        let waBtn = document.createElement("button");
        waBtn.innerText = "Whatsapp";

        waBtn.onclick = () => {
          let number = r.mobile;     // changed Number â†’ number
          let name = r.name;
          let vehicle = r.vehicle;
          let expiry = r.expiry;

          // Correct template literal
          let message = `Hello ${name}, your Vehicle Number  ${vehicle} Pucc Expires on ${expiry}`;

          // Debug all variables
          console.log("number:", number);
          console.log("name:", name);
          console.log("vehicle:", vehicle);
          console.log("expiry:", expiry);
          console.log("message:", message);

          let url = `https://wa.me/91${number}?text=${encodeURIComponent(message)}`;
          console.log("WhatsApp URL:", url);

          window.open(url, "_blank");
        };

        cell.appendChild(waBtn);

      });
      document.getElementById("totalCount").innerText = "Total Vehicles: " + data.length;
    }

    // Multi-field search function
    function filterTable() {
      let filter = document.getElementById("searchInput").value.toUpperCase();
      let filtered = reminders.filter(r =>
        r.name.toUpperCase().includes(filter) ||
        r.mobile.toUpperCase().includes(filter) ||
        r.vehicle.toUpperCase().includes(filter)
      );
      loadReminders(filtered);
    }

    loadReminders();


    document.addEventListener('DOMContentLoaded', () => {
      const table = document.getElementById('reminderTable');
      if (!table) return;

      // agar tbody nahi hai, tbody create kar lete hain
      let tbody = table.tBodies[0];
      if (!tbody) {
        tbody = document.createElement('tbody');
        // move all rows except first (header) into tbody
        const rows = Array.from(table.rows).slice(1);
        rows.forEach(r => tbody.appendChild(r));
        table.appendChild(tbody);
      }

      const rows = Array.from(tbody.rows);

      const columnIndex = 3; // 0-based, Expiry column

      function getDate(row) {
        const cell = row.cells[columnIndex];
        if (!cell) return null;
        const match = cell.textContent.match(/\d{4}-\d{2}-\d{2}/);
        return match ? match[0] : null;
      }

      const rowsWithDate = rows
        .map(row => ({ row, date: getDate(row) }))
        .filter(x => x.date)
        .sort((a, b) => new Date(a.date) - new Date(b.date))
        .map(x => x.row);

      const rowsWithoutDate = rows.filter(row => !getDate(row));

      tbody.innerHTML = '';
      rowsWithDate.forEach(r => tbody.appendChild(r));
      rowsWithoutDate.forEach(r => tbody.appendChild(r));
    });



  </script>

</body>

</html>